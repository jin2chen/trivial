/*
 project-site: http://plugins.jquery.com/project/AjaxManager
 repository: http://github.com/aFarkas/Ajaxmanager
 @author Alexander Farkas
 @version 3.06
 Copyright 2010, Alexander Farkas
 Dual licensed under the MIT or GPL Version 2 licenses.
*/
(function(b){var m={},o={};b.manageAjax=function(){return{create:function(a,c){m[a]=new b.manageAjax._manager(a,c);return m[a]},destroy:function(a){if(m[a]){m[a].clear(true);delete m[a]}}}}();b.manageAjax._manager=function(a,c){this.requests={};this.inProgress=0;this.qName=this.name=a;this.opts=b.extend({},b.ajaxSettings,b.manageAjax.defaults,c);if(c&&c.queue&&c.queue!==true&&typeof c.queue==="string"&&c.queue!=="clear")this.qName=c.queue};b.manageAjax._manager.prototype={add:function(a){a=b.extend({},
this.opts,a);var c=a.complete||b.noop,f=a.success||b.noop,g=a.beforeSend||b.noop,d=a.error||b.noop,e=typeof a.data=="string"?a.data:b.param(a.data||{}),k=a.type+a.url+e,n=this,l=this._createAjax(k,a,f,c);if(!(this.requests[k]&&a.preventDoubbleRequests)){l.xhrID=k;a.xhrID=k;a.beforeSend=function(h,i){var j=g.call(this,h,i);j===false&&n._removeXHR(k);return j};a.complete=function(h,i){n._complete.call(n,this,c,h,i,k,a)};a.success=function(h,i,j){n._success.call(n,this,f,h,i,j,a)};a.error=function(h,
i,j){var p="",q="";if(i!=="timeout"&&h){p=h.status;q=h.responseXML||h.responseText}d?d.call(this,h,i,j,a):setTimeout(function(){throw i+"| status: "+p+" | URL: "+a.url+" | data: "+e+" | thrown: "+j+" | response: "+q;},0);h=null};a.queue==="clear"&&b(document).clearQueue(this.qName);if(a.queue){b.queue(document,this.qName,l);this.inProgress<a.maxRequests&&b.dequeue(document,this.qName);return k}return l()}},_createAjax:function(a,c,f,g){var d=this;return function(){if(c.beforeCreate.call(c.context||
d,a,c)!==false){d.inProgress++;d.inProgress===1&&b.event.trigger(d.name+"AjaxStart");if(c.cacheResponse&&o[a]){d.requests[a]={};setTimeout(function(){d._complete.call(d,c.context||c,g,o[a],"success",a,c);d._success.call(d,c.context||c,f,o[a]._successData,"success",o[a],c)},0)}else if(c.async)d.requests[a]=b.ajax(c);else b.ajax(c);return a}}},_removeXHR:function(a){this.opts.queue&&b.dequeue(document,this.qName);this.inProgress--;this.requests[a]=null;delete this.requests[a]},_isAbort:function(a,c){return!!(c.abortIsNoSuccess&&
(!a||a.readyState===0||this.lastAbort===c.xhrID))},_complete:function(a,c,f,g,d,e){if(this._isAbort(f,e)){g="abort";e.abort.call(a,f,g,e)}c.call(a,f,g,e);b.event.trigger(this.name+"AjaxComplete",[f,g,e]);e.domCompleteTrigger&&b(e.domCompleteTrigger).trigger(this.name+"DOMComplete",[f,g,e]).trigger("DOMComplete",[f,g,e]);this._removeXHR(d);this.inProgress||b.event.trigger(this.name+"AjaxStop")},_success:function(a,c,f,g,d,e){var k=this;if(!this._isAbort(d,e)){e.abortOld&&b.each(this.requests,function(l){if(l===
e.xhrID)return false;k.abort(l)});if(e.cacheResponse&&!o[e.xhrID]){o[e.xhrID]={status:d.status,statusText:d.statusText,responseText:d.responseText,responseXML:d.responseXML,_successData:f};if(d.getAllResponseHeaders){var n=d.getAllResponseHeaders();b.extend(o[e.xhrID],{getAllResponseHeaders:function(){return n},getResponseHeader:function(){var l={};b.each(n.split("\n"),function(h,i){var j=i.indexOf(":");l[i.substr(0,j)]=i.substr(j+2)});return function(h){return l[h]}}()})}}c.call(a,f,g,d,e);b.event.trigger(this.name+
"AjaxSuccess",[d,e,f]);e.domSuccessTrigger&&b(e.domSuccessTrigger).trigger(this.name+"DOMSuccess",[f,e]).trigger("DOMSuccess",[f,e])}d=null},getData:function(a){if(a){var c=this.requests[a];if(!c&&this.opts.queue)c=b.grep(b(document).queue(this.qName),function(f){return f.xhrID===a})[0];return c}return{requests:this.requests,queue:this.opts.queue?b(document).queue(this.qName):[],inProgress:this.inProgress}},abort:function(a){var c;if(a){if((c=this.getData(a))&&c.abort){this.lastAbort=a;c.abort();
this.lastAbort=false}else b(document).queue(this.qName,b.grep(b(document).queue(this.qName),function(d){return d!==c}));c=null}else{var f=this,g=[];b.each(this.requests,function(d){g.push(d)});b.each(g,function(d,e){f.abort(e)})}},clear:function(a){b(document).clearQueue(this.qName);a&&this.abort()}};b.manageAjax._manager.prototype.getXHR=b.manageAjax._manager.prototype.getData;b.manageAjax.defaults={beforeCreate:b.noop,abort:b.noop,abortIsNoSuccess:true,maxRequests:1,cacheResponse:false,domCompleteTrigger:false,
domSuccessTrigger:false,preventDoubbleRequests:true,queue:false};b.each(b.manageAjax._manager.prototype,function(a,c){a.indexOf("_")===0||!b.isFunction(c)||(b.manageAjax[a]=function(f,g){if(!m[f])if(a==="add")b.manageAjax.create(f,g);else return;var d=Array.prototype.slice.call(arguments,1);m[f][a].apply(m[f],d)})})})(jQuery);
